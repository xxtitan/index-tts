# IndexTTS API æœåŠ¡å™¨

åŸºäº IndexTTS2 æ¨¡å‹çš„ REST API æœåŠ¡å™¨ï¼Œæä¾›æ–‡æœ¬è½¬è¯­éŸ³åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

- **å¼‚æ­¥å’ŒåŒæ­¥TTSç”Ÿæˆ**ï¼šæ”¯æŒå¼‚æ­¥ä»»åŠ¡å’ŒåŒæ­¥è¯·æ±‚
- **å¤šç§æƒ…æ„Ÿæ§åˆ¶æ–¹å¼**ï¼š
  - ä¸éŸ³è‰²å‚è€ƒéŸ³é¢‘ç›¸åŒ
  - ä½¿ç”¨æƒ…æ„Ÿå‚è€ƒéŸ³é¢‘
  - ä½¿ç”¨æƒ…æ„Ÿå‘é‡æ§åˆ¶ï¼ˆ8ç»´æƒ…æ„Ÿå‘é‡ï¼‰
  - ä½¿ç”¨æƒ…æ„Ÿæè¿°æ–‡æœ¬æ§åˆ¶
- **æ–‡ä»¶ä¸Šä¼ ç®¡ç†**ï¼šæ”¯æŒéŸ³é¢‘æ–‡ä»¶ä¸Šä¼ å’Œç®¡ç†
- **ä»»åŠ¡çŠ¶æ€è·Ÿè¸ª**ï¼šå®æ—¶æŸ¥çœ‹ç”Ÿæˆè¿›åº¦å’ŒçŠ¶æ€
- **é«˜çº§ç”Ÿæˆå‚æ•°**ï¼šæ”¯æŒé‡‡æ ·å‚æ•°ã€æŸæœç´¢ç­‰é…ç½®

## å®‰è£…ä¾èµ–

æœ¬é¡¹ç›®ä½¿ç”¨ `uv` è¿›è¡Œä¾èµ–ç®¡ç†ã€‚å®‰è£…APIæœåŠ¡å™¨ä¾èµ–ï¼š

```bash
# å®‰è£…APIæœåŠ¡å™¨ä¾èµ–
uv sync --extra api

# æˆ–è€…å®‰è£…æ‰€æœ‰å¯é€‰ä¾èµ–ï¼ˆåŒ…æ‹¬webuiå’Œdeepspeedï¼‰
uv sync --all-extras
```

å¦‚æœæ‚¨ä½¿ç”¨ä¼ ç»Ÿçš„pipï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨å®‰è£…ï¼š

```bash
pip install "fastapi>=0.104.0" "uvicorn[standard]>=0.24.0" "pydantic>=2.0.0" "python-multipart>=0.0.6"
```

## å¯åŠ¨æœåŠ¡å™¨

```bash
python api.py --model_dir ./checkpoints --port 8000 --host 0.0.0.0
```

### å¯åŠ¨å‚æ•°

- `--host`: æœåŠ¡å™¨ä¸»æœºåœ°å€ï¼ˆé»˜è®¤: 0.0.0.0ï¼‰
- `--port`: æœåŠ¡å™¨ç«¯å£ï¼ˆé»˜è®¤: 8000ï¼‰
- `--model_dir`: æ¨¡å‹æ£€æŸ¥ç‚¹ç›®å½•ï¼ˆé»˜è®¤: ./checkpointsï¼‰
- `--fp16`: ä½¿ç”¨FP16æ¨ç†
- `--deepspeed`: ä½¿ç”¨DeepSpeedåŠ é€Ÿ
- `--cuda_kernel`: ä½¿ç”¨CUDAå†…æ ¸
- `--workers`: å·¥ä½œè¿›ç¨‹æ•°ï¼ˆé»˜è®¤: 1ï¼‰
- `--reload`: å¼€å‘æ¨¡å¼çƒ­é‡è½½

## API æ–‡æ¡£

å¯åŠ¨æœåŠ¡å™¨åï¼Œè®¿é—® `http://localhost:8000/docs` æŸ¥çœ‹å®Œæ•´çš„ API æ–‡æ¡£ã€‚

## ä¸»è¦ API ç«¯ç‚¹

### 1. å¥åº·æ£€æŸ¥
```
GET /api/v1/health
```

### 2. å¼‚æ­¥TTSç”Ÿæˆ
```
POST /api/v1/tts
```

### 3. åŒæ­¥TTSç”Ÿæˆ
```
POST /api/v1/tts/sync
```

### 4. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
```
GET /api/v1/task/{task_id}
```

### 5. è·å–ç”Ÿæˆçš„éŸ³é¢‘
```
GET /api/v1/audio/{task_id}
```

### 6. ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
```
POST /api/v1/upload/audio
```

### 7. è·å–æ–‡ä»¶ä¿¡æ¯
```
GET /api/v1/file/{file_id}
```

### 8. ä»»åŠ¡ç®¡ç†
```
GET /api/v1/tasks          # åˆ—å‡ºä»»åŠ¡
DELETE /api/v1/task/{task_id}  # åˆ é™¤ä»»åŠ¡
```

## ä½¿ç”¨ç¤ºä¾‹

### Python å®¢æˆ·ç«¯ç¤ºä¾‹

```python
import requests
import time

# æœåŠ¡å™¨åœ°å€
BASE_URL = "http://localhost:8000"

# 1. ä¸Šä¼ éŸ³è‰²å‚è€ƒéŸ³é¢‘
with open("prompt.wav", "rb") as f:
    response = requests.post(
        f"{BASE_URL}/api/v1/upload/audio",
        files={"file": f}
    )
    prompt_file_id = response.json()["file_id"]

# 2. éªŒè¯æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼ˆå¯é€‰ï¼‰
file_info = requests.get(f"{BASE_URL}/api/v1/file/{prompt_file_id}")
print(f"ä¸Šä¼ çš„æ–‡ä»¶ä¿¡æ¯: {file_info.json()}")

# 3. å¼‚æ­¥ç”ŸæˆTTS
tts_request = {
    "text": "ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è¯­éŸ³ã€‚",
    "prompt_audio_id": prompt_file_id,
    "emo_control_method": 0,
    "max_text_tokens_per_segment": 120
}

response = requests.post(f"{BASE_URL}/api/v1/tts", json=tts_request)
task_id = response.json()["task_id"]

# 4. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
while True:
    response = requests.get(f"{BASE_URL}/api/v1/task/{task_id}")
    status = response.json()
    
    if status["status"] == "completed":
        print("ç”Ÿæˆå®Œæˆï¼")
        # ä¸‹è½½éŸ³é¢‘
        audio_response = requests.get(f"{BASE_URL}/api/v1/audio/{task_id}")
        with open("output.wav", "wb") as f:
            f.write(audio_response.content)
        break
    elif status["status"] == "failed":
        print(f"ç”Ÿæˆå¤±è´¥: {status['message']}")
        break
    else:
        print(f"è¿›åº¦: {status['progress']*100:.1f}%")
        time.sleep(1)
```

### curl ç¤ºä¾‹

```bash
# å…ˆä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
curl -X POST "http://localhost:8000/api/v1/upload/audio" \
  -F "file=@prompt.wav"

# ä½¿ç”¨è¿”å›çš„file_idè¿›è¡ŒTTSç”Ÿæˆ
curl -X POST "http://localhost:8000/api/v1/tts/sync" \
  -H "Content-Type: application/json" \
  -d '{
    "text": "ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è¯­éŸ³ã€‚",
    "prompt_audio_id": "your-file-id-here",
    "emo_control_method": 0,
    "max_text_tokens_per_segment": 120
  }'
```

## æƒ…æ„Ÿæ§åˆ¶è¯´æ˜

### æƒ…æ„Ÿæ§åˆ¶æ–¹å¼

- `0`: ä¸éŸ³è‰²å‚è€ƒéŸ³é¢‘ç›¸åŒ
- `1`: ä½¿ç”¨æƒ…æ„Ÿå‚è€ƒéŸ³é¢‘ï¼ˆéœ€è¦æä¾› `emo_audio_path`ï¼‰
- `2`: ä½¿ç”¨æƒ…æ„Ÿå‘é‡æ§åˆ¶ï¼ˆéœ€è¦æä¾› `emo_vector`ï¼‰
- `3`: ä½¿ç”¨æƒ…æ„Ÿæè¿°æ–‡æœ¬æ§åˆ¶ï¼ˆéœ€è¦æä¾› `emo_text`ï¼‰

### æƒ…æ„Ÿå‘é‡

8ç»´å‘é‡ï¼Œåˆ†åˆ«å¯¹åº”ï¼š[å–œ, æ€’, å“€, æƒ§, åŒæ¶, ä½è½, æƒŠå–œ, å¹³é™]
æ¯ä¸ªå€¼èŒƒå›´ä¸º 0.0-1.0ã€‚

ç¤ºä¾‹ï¼š
```json
{
  "emo_control_method": 2,
  "emo_vector": [0.8, 0.0, 0.0, 0.0, 0.0, 0.0, 0.2, 0.3]
}
```

## å®‰å…¨æ€§å’Œå»é‡è¯´æ˜

### ğŸ”’ å®‰å…¨æ€§
- **SHAå“ˆå¸ŒIDç³»ç»Ÿ**ï¼šAPIä½¿ç”¨SHA256å“ˆå¸Œå€¼ä½œä¸ºæ–‡ä»¶IDï¼Œç¡®ä¿æ–‡ä»¶å”¯ä¸€æ€§å’Œå®‰å…¨æ€§
- **æ–‡ä»¶éªŒè¯**ï¼šæ‰€æœ‰æ–‡ä»¶IDéƒ½å¿…é¡»æ˜¯64ä½åå…­è¿›åˆ¶SHA256å“ˆå¸Œå€¼ï¼Œç»è¿‡ä¸¥æ ¼éªŒè¯
- **è·¯å¾„å®‰å…¨**ï¼šå†…éƒ¨è‡ªåŠ¨æ‹¼æ¥å®‰å…¨çš„æ–‡ä»¶è·¯å¾„ï¼Œé˜²æ­¢è·¯å¾„éå†æ”»å‡»
- **æ–‡ä»¶æ ¼å¼é™åˆ¶**ï¼šåªå…è®¸ä¸Šä¼ ç‰¹å®šæ ¼å¼çš„éŸ³é¢‘æ–‡ä»¶ï¼ˆ.wav, .mp3, .m4a, .flacï¼‰

### ğŸ”„ æ–‡ä»¶å»é‡
- **å†…å®¹å“ˆå¸Œ**ï¼šä½¿ç”¨æ–‡ä»¶å†…å®¹çš„SHA256å“ˆå¸Œå€¼ä½œä¸ºå”¯ä¸€æ ‡è¯†
- **è‡ªåŠ¨å»é‡**ï¼šç›¸åŒå†…å®¹çš„æ–‡ä»¶åªä¼šä¿å­˜ä¸€ä»½ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´
- **é‡å¤æ£€æµ‹**ï¼šä¸Šä¼ é‡å¤æ–‡ä»¶æ—¶ä¼šè¿”å›ç°æœ‰æ–‡ä»¶çš„ä¿¡æ¯ï¼Œæ ‡è®°ä¸º`is_duplicate: true`

## æ³¨æ„äº‹é¡¹

1. **æ–‡ä»¶ç®¡ç†**ï¼šä¸Šä¼ çš„æ–‡ä»¶ä¼šåœ¨1å°æ—¶åè‡ªåŠ¨æ¸…ç†ï¼Œç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶ä¼šåœ¨24å°æ—¶åæ¸…ç†
2. **å¹¶å‘é™åˆ¶**ï¼šå»ºè®®æ ¹æ®GPUæ˜¾å­˜è°ƒæ•´workeræ•°é‡
3. **éŸ³é¢‘æ ¼å¼**ï¼šæ”¯æŒä¸Šä¼  .wav, .mp3, .m4a, .flac æ ¼å¼çš„éŸ³é¢‘æ–‡ä»¶
4. **æ–‡æœ¬é•¿åº¦**ï¼šé•¿æ–‡æœ¬ä¼šè‡ªåŠ¨åˆ†å¥å¤„ç†ï¼Œå¯é€šè¿‡ `max_text_tokens_per_segment` è°ƒæ•´åˆ†å¥é•¿åº¦

## é”™è¯¯å¤„ç†

API ä½¿ç”¨æ ‡å‡†çš„ HTTP çŠ¶æ€ç ï¼š

- `200`: æˆåŠŸ
- `400`: è¯·æ±‚å‚æ•°é”™è¯¯
- `404`: èµ„æºä¸å­˜åœ¨
- `500`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

é”™è¯¯å“åº”æ ¼å¼ï¼š
```json
{
  "success": false,
  "message": "é”™è¯¯æè¿°"
}
```
